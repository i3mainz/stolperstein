<html>
<head><title>Stolperstein Map</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
<link rel="stylesheet" href="css/leaflet-search.css" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
  <script src="js/leaflet.polylinedecorator.js"></script>
  <script src="js/wicket.js" type="text/javascript"></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
     <script src="js/leaflet.fullscreen.js"></script>
	 <script src="js/leaflet-search.js"></script>
   <script src="js/leaflet_legend.js"></script>
   <script src="testdata/stolpersteinemainz.js"></script>
   <script src="testdata/stolpersteinewiesbaden.js"></script>
   <script src="testdata/stolpersteineaschaffenburg.js"></script>
   <script src="testdata/stolpersteine_mapping.js"></script>
      <script src="js/leaflet_easyprint.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  
<script>
var prefixlist="@prefix owl: <http://www.w3.org/2002/07/owl#> .\n @prefix foaf: <http://xmlns.com/foaf/0.1/> .\n @prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> . @prefix xml: <http://www.w3.org/XML/1998/namespace> . \n @prefix xsd: <http://www.w3.org/2001/XMLSchema#> . \n @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> . \n"
var overlayMaps={}
var ttlExport="";
var minMapZoom=12;
var resultLayerCollection=[]
var combinedCounter=0
var loaded=false;
function saveToOWL(){
    saveTextAsFile();
}

function saveTextAsFile()
{
    var blob = new Blob([prefixlist+"<http://semgis.i3mainz.de> rdf:type owl:Ontology . \n"+ttlExport], {type:'text/plain'});
    var filename = "res.ttl";
    var a = document.createElement('a');
    a.style = "display: none";  
    var url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
        a.click();
    setTimeout(function(){
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
    }, 1000);
   
}

function saveTextAsFile2(text)
{
    var blob = new Blob([JSON.stringify(text)], {type:'text/geojson'});
    var filename = "res.geojson";
    var a = document.createElement('a');
    a.style = "display: none";  
    var url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
        a.click();
    setTimeout(function(){
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
    }, 1000);
   
}

function editDistance(a, b){
  if(a.length == 0) return b.length; 
  if(b.length == 0) return a.length; 
  a=a.toLowerCase()
  b=b.toLowerCase()
  var matrix = [];

  // increment along the first column of each row
  var i;
  for(i = 0; i <= b.length; i++){
    matrix[i] = [i];
  }

  // increment each column in the first row
  var j;
  for(j = 0; j <= a.length; j++){
    matrix[0][j] = j;
  }

  // Fill in the rest of the matrix
  for(i = 1; i <= b.length; i++){
    for(j = 1; j <= a.length; j++){
      if(b.charAt(i-1) == a.charAt(j-1)){
        matrix[i][j] = matrix[i-1][j-1];
      } else {
        matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, // substitution
                                Math.min(matrix[i][j-1] + 1, // insertion
                                         matrix[i-1][j] + 1)); // deletion
      }
    }
  }

  return matrix[b.length][a.length];
};


function buildOverpassApiUrl(map, overpassQuery,overpassQueryVal) {
        var bounds = map.getBounds().getSouth() + ',' + map.getBounds().getWest() + ',' + map.getBounds().getNorth() + ',' + map.getBounds().getEast();
        var nodeQuery = 'node[' + (overpassQueryVal==""?overpassQuery:"'"+overpassQuery+"'='"+overpassQueryVal+"'") + '](' + bounds + ');';
        var wayQuery = 'way[' + (overpassQueryVal==""?overpassQuery:"'"+overpassQuery+"'='"+overpassQueryVal+"'") + '](' + bounds + ');';
        var relationQuery = 'relation[' + (overpassQueryVal==""?overpassQuery:"'"+overpassQuery+"'='"+overpassQueryVal+"'") + '](' + bounds + ');';
        var query = '?data=[out:json][timeout:15];(' + nodeQuery + wayQuery + relationQuery + ');out geom;';
        var baseUrl = 'https://overpass-api.de/api/interpreter';
        var resultUrl = baseUrl + query;
        return resultUrl;
}

function matchGeometryInGeoJSONSet(geometry,geojsonset,compareatt,osmprop){
	console.log(geometry)
	if(geometry.type=="Polygon"){
		var point=turf.polygon(geometry.coordinates);
	}else if(geometry.type=="MultiPolygon"){
		return null;
	}else if(geometry.type=="LineString"){
		var point=turf.lineString(geometry.coordinates);
	}else if(geometry.type=="MultiLineString"){
		return null;
	}else if(geometry.type=="Point"){
		var pointt=turf.point(geometry.coordinates);
		var point = turf.buffer(pointt, 50, {units: 'meters'});
		console.log(point)
	}else if(geometry.type=="MultiPoint"){
		return null;
	}
    console.log(point)
	var result=null
	var lastmatched=null
	for(geojson in geojsonset){
		if(turf.booleanContains(point,geojsonset[geojson])){
			lastmatched=geojsonset[geojson]
			console.log(osmprop)
			console.log(geojsonset[geojson]["properties"]["Name"])
			if(typeof osmprop !== 'undefined' 
			   && (osmprop.toLowerCase().includes(geojsonset[geojson]["properties"]["Name"].toLowerCase()) || 
			      geojsonset[geojson]["properties"]["Name"].toLowerCase().includes(osmprop.toLowerCase()))){
			console.log("Result: "+geojsonset[geojson])
			return geojsonset[geojson];				
			}
		}
	}
	return lastmatched;
}

var osmDataGeoJSON={}
var wdDataGeoJSON={}
var combinedDataGeoJSON={}
var tagToValues={}

function exportOSM(){
    saveTextAsFile2(osmDataGeoJSON)
}

function exportWD(){
    saveTextAsFile2(wdDataGeoJSON)
}

function exportCombined(){
    saveTextAsFile2(tagToValues)
}



function getOSMAttributesForCoordinate(map){
var counter=0;
if(map.getZoom()>=minMapZoom){
$.get(buildOverpassApiUrl(map,"memorial:type","stolperstein"), function (osmDataAsJson) {
          var resultAsGeojson = osmtogeojson(osmDataAsJson);
          osmDataGeoJSON=resultAsGeojson
          wdDataGeoJSON={}
          wdDataGeoJSON["features"]={}
		  var adminLayer=null
          var resultLayer = L.geoJson(resultAsGeojson, {
            style: function (feature) {
              return {color: "#ff0000"};
            },
            filter: function (feature, layer) {			
				
              return true;
            },
            onEachFeature: function (feature, layer) {
              combinedDataGeoJSON=[]
              var popupContent = "";
		    	  wdkeyset={}
              console.log("Wikidata: "+feature.properties.tags["wikidata"])
              if(feature.properties.tags["wikidata"]!="" && feature.properties.tags["wikidata"]!=undefined){
                    wdkeyset=getAttributesForWikidataID(feature.properties.tags["wikidata"])
             }
             combinedDataGeoJSON[combinedCounter]={}
             combinedDataGeoJSON[combinedCounter]={"wikidata":wdDataGeoJSON,"osm":""}             
             console.log(wdDataGeoJSON)
             wdDataGeoJSON["features"][counter]=JSON.parse(JSON.stringify(feature));
             wdDataGeoJSON["features"][counter]["properties"]=wdkeyset
            counter+=1
            var officialdata=matchGeometryInGeoJSONSet(feature.geometry,window[$('#officialsetmenu').val()].features,"Name",feature.properties.tags["name"])
			  console.log(JSON.stringify(officialdata))
              popupContent = popupContent + "<b>" + feature.properties.type + "/" + feature.properties.id + "</b><br/>";
			  coord="Coordinates: "+feature.geometry.type+"("+feature.geometry.coordinates[0]+" "+feature.geometry.coordinates[1]+")"
			  popupContent+=trimcoords(coord,90)
              var indid="<http://www.linkedgeodata.org/"+feature.properties.type+feature.properties.id+">";
              if(officialdata!=null){
				if(officialdata["properties"]!=null){
					popupContent+="<br/>Official Data Attributes:<ul>"
					var keys = Object.keys(officialdata["properties"]).sort();
					for(prop in keys){
						console.log(keys[prop])
						console.log(officialdata.properties[keys[prop]])
						if(keys[prop] in equivs){	
							console.log(equivs[keys[prop]]["osm"])						
							console.log(feature.properties.tags[equivs[keys[prop]]["osm"]])
							osmkey=equivs[keys[prop]]["osm"]
							wdkey=equivs[keys[prop]]["wikidata"]
							valtocompare=feature.properties.tags[osmkey]
							wdvaltocompare=wdkeyset[equivs[keys[prop]]["wikidata"]]
							console.log(osmkey+" - "+wdkey+" - "+valtocompare+" - "+wdvaltocompare+" - "+officialdata.properties[keys[prop]])
							console.log(osmkey+" - "+feature.properties.tags[osmkey])
							if(osmkey in feature.properties.tags && officialdata.properties[keys[prop]]!=valtocompare){
								popupContent+="<li><span style=\"color:orange;text-decoration:underline;\">"+keys[prop]+"</span> - <span style=\"color:orange;text-decoration:underline;\">"+officialdata.properties[keys[prop]]+" | "+feature.properties.tags[osmkey];
								if(officialdata.properties[keys[prop]]!=null && feature.properties.tags[osmkey]!=null){
                                    popupContent+=" ["+editDistance(officialdata.properties[keys[prop]],feature.properties.tags[osmkey])+"]"
								}
								popupContent+=" (OSM)</span></li>"
								console.log(tagToValues)
								console.log(keys[prop])
								if(!(keys[prop] in tagToValues)){
                                    tagToValues[keys[prop]]={}
								}
								if(!(officialdata.properties[keys[prop]] in tagToValues[keys[prop]])){
                                    tagToValues[keys[prop]][officialdata.properties[keys[prop]]]={}
								}
								if(officialdata.properties[keys[prop]]!=null && feature.properties.tags[osmkey]!=null){
                                    distance=editDistance(officialdata.properties[keys[prop]].toLowerCase(),feature.properties.tags[osmkey].toLowerCase())
                                    substring=feature.properties.tags[osmkey].toLowerCase().includes(officialdata.properties[keys[prop]].toLowerCase())
								}else{
                                    distance=""
                                    substring=false
								}
								tagToValues[keys[prop]][officialdata.properties[keys[prop]]]["osm"]={"key":osmkey,"value":feature.properties.tags[osmkey],"distance":distance,"substring":substring}
                                console.log(JSON.stringify(tagToValues))
								console.log(keys[prop])
							}else if(osmkey in feature.properties.tags && officialdata.properties[keys[prop]]==valtocompare){
								popupContent+="<li><span style=\"color:green;text-decoration:underline;\">"+keys[prop]+"</span> - <span style=\"color:green;text-decoration:underline;\">"+officialdata.properties[keys[prop]]+" (OSM)</span></li>"
							}else if(wdkey in wdkeyset && officialdata.properties[keys[prop]]!=wdvaltocompare){
								popupContent+="<li><span style=\"color:green;text-decoration:underline;\">"+keys[prop]+"</span> - <span style=\"color:orange;text-decoration:underline;\">"+officialdata.properties[keys[prop]]+" | "+wdkeyset[wdkey]+" ["+editDistance(officialdata.properties[keys[prop]],wdkey)+"] (Wikidata)</span></li>"
                                if(!(keys[prop] in tagToValues)){
                                    tagToValues[keys[prop]]={}
								}
								if(!(officialdata.properties[keys[prop]] in tagToValues[keys[prop]])){
                                    tagToValues[keys[prop]][officialdata.properties[keys[prop]]]={}
								}
								tagToValues[keys[prop]][officialdata.properties[keys[prop]]]["wikidata"]={"key":wdkey,"value":wdkeyset[wdkey],"distance":editDistance(officialdata.properties[keys[prop]].toLowerCase(),wdkeyset[wdkey].toLowerCase()),"substring":wdkeyset[wdkey].toLowerCase().includes(officialdata.properties[keys[prop]].toLowerCase())}
							}else if(wdkey in wdkeyset && officialdata.properties[keys[prop]]==wdvaltocompare){
								popupContent+="<li><span style=\"color:green;text-decoration:underline;\">"+keys[prop]+"</span> - <span style=\"color:green;text-decoration:underline;\">"+officialdata.properties[keys[prop]]+" (Wikidata)</span></li>"
                                console.log(tagToValues)
								console.log(keys[prop])
							}else{
								popupContent+="<li><span style=\"color:orange;text-decoration:underline;\">"+keys[prop]+"</span> - <span>"+officialdata.properties[keys[prop]]+"</span></li>"
							}
					}else{
							popupContent+="<li><span>"+keys[prop]+"</span> - "+officialdata.properties[keys[prop]]+"</li>"
						}
						
					}
					popupContent+="</ul>"
				}
			  }
			  console.log(popupContent)
              popupContent+="<br/>OSM Attributes:<ul>"
              var keys = Object.keys(feature.properties.tags);
              if(feature.properties.tags.length>0){
					var wicket = new Wkt.Wkt();
					wicket.read(JSON.stringify(feature["geometry"]));
					var wkt = wicket.write();
					ttlExport+="<http://www.linkedgeodata.org/"+feature.properties.type+feature.properties.id+"> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://www.w3.org/2002/07/owl#NamedIndividual> .\n"
					ttlExport+="<http://www.linkedgeodata.org/"+feature.properties.type+feature.properties.id+"> <http://www.opengis.net/ont/geosparql#hasGeometry> \""+wkt+"\"^^<http://www.opengis.net/ont/geosparql#wktLiteral> .\n";
					var isPolygon = (feature.geometry) && (feature.geometry.type !== undefined) && (feature.geometry.type === "Polygon");
					if (isPolygon) {
						feature.geometry.type = "Point";
						var polygonCenter = L.latLngBounds(feature.geometry.coordinates[0]).getCenter();
						feature.geometry.coordinates = [ polygonCenter.lat, polygonCenter.lng ];
						var wicket = new Wkt.Wkt();
						wicket.read(JSON.stringify(feature.geometry));
						var wkt = wicket.write();
						ttlExport+="<http://www.linkedgeodata.org/"+feature.properties.type+feature.properties.id+"> <http://www.opengis.net/ont/geosparql#hasGeometry> \""+wkt+"\"^^<http://www.opengis.net/ont/geosparql#wktLiteral> .\n";
					}
              }
              keys.forEach(function (key) {
              var ignorekeys=[]
                popupContent = popupContent + "<li>"
                                /*alert(JSON.stringify(wdkeyset))
                                if(key in osmToWikidataMap)
                                    alert(JSON.stringify(Object.keys(Object.values(osmToWikidataMap[key])[0])[0]))*/
				if(key=="wikidata"){
					popupContent = popupContent + "<a href=\"https://wiki.openstreetmap.org/wiki/Key:wikidata\" target=\"_blank\" style=\"color:#ff0000\">wikidata</a> - <a href=\"https://www.wikidata.org/entity/"+feature.properties.tags[key]+"\"  target=\"_blank\" style=\"color:#ff0000\">" + feature.properties.tags[key] + "</a></li>";
					ttlExport+=indid+" <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://www.wikidata.org/entity/"+feature.properties.tags[key]+"> . \n"  
				}else if(key in osmToWikidataMap && (Object.keys(Object.values(osmToWikidataMap[key])[0])[0] in wdkeyset)){
                                                popupContent+="<a style=\"color:green\" href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\">"+key+"</a>"
						wdval=Object.values(wdkeyset[Object.keys(Object.values(osmToWikidataMap[key])[0])[0]])[0].split(";")[1]
						if(feature.properties.tags[key].includes("http")){
							ttlExport+=indid+(feature.properties.tags[key].includes("http")?"<"+feature.properties.tags[key]+">":"\""+feature.properties.tags[key]+"\"")+" "+(wdval.includes("http")?"<"+wdval+">":"\""+wdval+"\"")+" . \n"  
                        }
                        if(wdval==feature.properties.tags[key]){
								if(feature.properties.tags[key].includes("http")){
									popupContent = popupContent + " - <a href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\" style=\"color:green\">" + feature.properties.tags[key] + "</a></li>";
								}else{
									popupContent = popupContent + " - <span style=\"color:green\">" + feature.properties.tags[key] + "</span></li>";
								}
                                
                        }else{
							if(feature.properties.tags[key].includes("http")){
								popupContent = popupContent + " - <a href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\" style=\"color:orange\">" + feature.properties.tags[key] + "</a>" 
							}else{
								popupContent = popupContent + " - <span style=\"color:orange\">" + feature.properties.tags[key] + "</span>";
							}
							if(wdval.includes("http")){
								popupContent +=" | <a href=\""+wdval+"\" target=\"_blank\">"+wdval+"</a></li>";
							}else{
								popupContent +=" | <span style=\"color:orange\">"+wdval+"</span></li>";
							}
                   }
                }else if(key in osmToWikidataMap && feature.properties.tags[key] in osmToWikidataMap[key] && "http://www.wikidata.org/entity/P31" in wdkeyset && Object.values(wdkeyset["http://www.wikidata.org/entity/P31"])[0].substring(0,Object.values(wdkeyset["http://www.wikidata.org/entity/P31"])[0].indexOf(";"))==Object.keys(osmToWikidataMap[key][feature.properties.tags[key]])[0]){
					 popupContent+="<a style=\"color:green\" href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\">"+key+"</a>"
					if(feature.properties.tags[key].includes("http")){
						popupContent = popupContent + " - <a href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\" style=\"color:green\">" + feature.properties.tags[key] + "</a></li>";
					}else{
						popupContent = popupContent + " - <a href=\""+Object.keys(osmToWikidataMap[key][feature.properties.tags[key]])[0]+"\" target=\"_blank\" style=\"color:green\">" + feature.properties.tags[key] + "</a></li>";
					}
				}else if(key in osmToWikidataMap){
						var color="orange"
                        popupContent+="<a style=\"color:"+color+"\" href=\"https://wiki.openstreetmap.org/wiki/Key:"+key+"\" target=\"_blank\">"+key+"</a>"
                                        if(feature.properties.tags[key].includes(".jpg") || feature.properties.tags[key].includes(".JPG") || feature.properties.tags[key].includes(".svg") || feature.properties.tags[key].includes(".SVG")
						|| feature.properties.tags[key].includes(".png") || feature.properties.tags[key].includes(".PNG") || feature.properties.tags[key].includes(".gif") || feature.properties.tags[key].includes(".GIF")){
						popupContent+=" - <a href=\""+feature.properties.tags[key]+"\" target=\"_blank\"><img src=\""+feature.properties.tags[key].replace("http","https")+"\" height=\"30\" width=\"30\"></a></li>"			
					}else if(feature.properties.tags[key].includes("http")){
						popupContent = popupContent + " - <a href=\""+feature.properties.tags[key]+"\" target=\"_blank\">" + feature.properties.tags[key] + "</a></li>";
					}else if(feature.properties.tags[key].startsWith("www.")){
						popupContent+=" - <a href=\"https://"+feature.properties.tags[key]+"\" target=\"_blank\">"+feature.properties.tags[key]+"</a></li>"
					}else{
						popupContent = popupContent + " - " + feature.properties.tags[key] + "</li>";
					}
                }else{
                    popupContent+="<a href=\"https://wiki.openstreetmap.org/wiki/Key:"+key+"\" target=\"_blank\"style=\"color:black;text-decoration: none;\">"+key+"</a>"
				if(key.includes("P625"))
					wdcoords=wdkeyset[key]
			if(feature.properties.tags[key].includes(".jpg") || feature.properties.tags[key].includes(".JPG") || feature.properties.tags[key].includes(".svg") || feature.properties.tags[key].includes(".SVG")
				|| feature.properties.tags[key].includes(".png") || feature.properties.tags[key].includes(".PNG") || feature.properties.tags[key].includes(".gif") || feature.properties.tags[key].includes(".GIF")){
			    	popupContent+=" - <a href=\""+feature.properties.tags[key]+"\" target=\"_blank\"><img src=\""+feature.properties.tags[key].replace("http","https")+"\" height=\"30\" width=\"30\"></a></li>"			
		    }else if(feature.properties.tags[key].includes("http")){
					popupContent = popupContent + " - <a href=\""+feature.properties.tags[key]+"\" target=\"_blank\">" + feature.properties.tags[key] + "</a></li>";
		    }else if(feature.properties.tags[key].startsWith("www.")){
			    	popupContent+="<a href=\"https://"+feature.properties.tags[key]+"\" target=\"_blank\">"+feature.properties.tags[key]+"</a></li>"
			}else{
					popupContent = popupContent + " - " + feature.properties.tags[key] + "</li>";
		    }
                     
                }
              });
              popupContent = popupContent + "</ul>"
			  //alert(wdkeyset)
			  if(feature.properties.tags["wikidata"]!== undefined){
              popupContent+="Wikidata Items: "/*<b>"+Object.values(wdkeyset["rdfs:label"])[0]+"</b>*/+"<ul>"
			  }
			  var wdcoords;
              for(key in wdkeyset){
					//if(key=="rdfs:label")
					//	continue;
					var isgreen=false;
                    giventag=""
                  if(!(Object.values(wdkeyset[key])[0].includes("statement"))){
                            spl=Object.values(wdkeyset[key])[0].split(";")
							wdval=spl[1]
							if(key.includes("P31")){
								//alert("P31: "+spl[0])
								if(spl[0] in wikidataToOSMMap){
									tags=Object.keys(wikidataToOSMMap[spl[0]][0])[0].split("=")
									//alert(JSON.stringify(tags))
									if(tags[0] in feature.properties.tags && feature.properties.tags[tags[0]]==tags[1]){
										popupContent+="<li><a href=\""+key+"\" target=\"_blank\" style=\"color:green\">"+Object.keys(wdkeyset[key])[0]+"</a> - "
										isgreen=true;
									}
								}
								//alert(JSON.stringify(wikidataToOSMMap))
							}
							else if(key in wikidataToOSMMap){
								//alert(JSON.stringify(wikidataToOSMMap[key]))
								var finished=false;
								for(equiv in Object.values(wikidataToOSMMap[key])[0]){
								
									if(feature.properties.tags[equiv]){
										popupContent+="<li><a href=\""+key+"\" target=\"_blank\" style=\"color:green\">"+Object.keys(wdkeyset[key])[0]+"</a> - "
										giventag=feature.properties.tags[equiv]
										finished=true;
									}
								}
								if(!finished){
									popupContent+="<li><a href=\""+key+"\" target=\"_blank\" style=\"color:orange\">"+Object.keys(wdkeyset[key])[0]+"</a> - "
								}
							}else{
                                    popupContent+="<li><a href=\""+key+"\" target=\"_blank\">"+Object.keys(wdkeyset[key])[0]+"</a> - "
                            }
			    if(spl[0].includes(".jpg") || spl[0].includes(".JPG")|| spl[0].includes(".svg") || spl[0].includes(".SVG")
				|| spl[0].includes(".png") || spl[0].includes(".PNG")){
			    	popupContent+="<a href=\""+spl[0]+"\" target=\"_blank\"";
					popupContent+="><img src=\""+spl[1].replace("http","https")+"\" height=\"30\" width=\"30\"></a></li>"
					ttlExport+=indid+" <"+key+"> <"+spl[0]+"> . \n"  
			    }else if(spl[0].includes("http")){
					if((finished && giventag==spl[1]) || isgreen){
						popupContent+="<a href=\""+spl[0]+"\" target=\"_blank\" style=\"color:green\">"+spl[1]+"</a></li>"
					}else if(finished && giventag!=spl[1] && giventag!=""){
						popupContent+="<a href=\""+spl[0]+"\" target=\"_blank\" style=\"color:orange\">"+spl[1]+"</a> | "+(giventag.includes("http")?"<a href=\""+giventag+"\" style=\"color:orange\">"+giventag+"["+editDistance(giventag,spl[1])+"]</a>":"<span style=\"color:orange\">"+giventag+" ["+editDistance(giventag,spl[1])+"]</span>")+"</li>"
					}else{
						popupContent+="<a href=\""+spl[0]+"\" target=\"_blank\">"+spl[1]+"</a></li>"
					}	
					ttlExport+=indid+" <"+key+"> <"+spl[0]+"> . \n"  
			    }else if(spl[0].startsWith("www.")){
					if((finished && giventag==spl[1]) || isgreen){
						popupContent+="<a href=\"https://"+spl[0]+"\" target=\"_blank\" style=\"color:green\">"+spl[1]+"</a></li>"
					}else if(finished && giventag!=spl[1] && giventag!=""){
						popupContent+="<a href=\"https://"+spl[0]+"\" target=\"_blank\" style=\"color:orange\">"+spl[1]+"</a> | "+(giventag.includes("http")?"<a href=\""+giventag+"\" style=\"color:orange\">"+giventag+" ["+editDistance(giventag,spl[1])+"]</a>":"<span style=\"color:orange\">"+giventag+" ["+editDistance(giventag,spl[1])+"]</span>")+"</li>"
					}else{
						popupContent+="<a href=\"https://"+spl[0]+"\" target=\"_blank\">"+spl[1]+"</a></li>"
					}		
					ttlExport+=indid+" <"+key+"> <"+spl[0]+"> . \n"  
			    }else{
					if((finished && giventag==spl[1]) || isgreen){
						popupContent+="<span style=\"color:green\">"+spl[1]+"</span></li>"
					}else if(finished && giventag!=spl[1] && giventag!=""){
						popupContent+="<span style=\"color:orange\">"+spl[1]+" | "+giventag+" ["+editDistance(giventag,spl[1])+"]</span></li>"
					}else{
						popupContent+=spl[1]+"</li>"
					}
			    	ttlExport+=indid+" <"+key+">  \""+spl[0]+"\" . \n"  
			    }
                        }
              }
              popupContent+="</ul>"
			  if(feature.properties.tags["wikidata"]!== undefined){
						var greyIcon = new L.Icon({
                                        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    });
						layer.setIcon(greyIcon);
			  }
			  if(officialdata!=null && "geometry" in officialdata){
				dist=getDistance(feature.geometry,officialdata["geometry"])
				if(dist!=""){
					popupContent+="Distance: "+dist.toFixed(2)+"m"
				}
			  } 
              layer.bindPopup(popupContent,{maxWidth : 560});
             // console.log(ttlExport)
            }
          }).addTo(map);
		  resultLayerCollection.push(resultLayer);
        });
    }
}

function trimcoords(coords,length){
	return coords.length > length ? coords.replace("undefined,","").substring(0, length - 3) + "...)" : coords;	
}

function getDistance(origin, destination) {
    console.log("Distance: "+JSON.stringify(origin))
    console.log("Distance2: "+JSON.stringify(destination))
	try{
	var fromm;
	if(origin.type=="Polygon"){
		var polygon=turf.polygon(origin.coordinates)
		fromm=turf.centroid(polygon);
	}else{
		fromm=turf.point(origin.coordinates);
	}
	if("coordinate location" in destination && destination["coordinate location"].includes("Polygon")){
		var polygon=turf.polygon(destination["coordinate location"])
		to=turf.centroid(polygon);
	}else{
		to=turf.point(destination["coordinates"]);
	}
	var options={units: 'kilometers'}
	var dest=turf.distance(fromm,to,options)*1000
	return dest
	}catch(e){
	    console.log(e)
		return "";
	}
}

	
function wikidataAroundQuery(coord,width){
if(map.getZoom()>=minMapZoom){
var markers=[]
var wikidatagroup=L.layerGroup().addTo(map)
var query = [ "PREFIX bd: <http://www.bigdata.com/rdf#>\n",
 "PREFIX wikibase: <http://wikiba.se/ontology#>\n",
 "PREFIX wdt: <http://www.wikidata.org/prop/direct/>\n",
 "PREFIX wd: <http://www.wikidata.org/entity/>\n",
 "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>\n",
 "SELECT ?item ?itemLabel ?location ?rel ?relLabel ?val ?valLabel  WHERE\n",
 "{\n",
  " ?item wdt:P31 wd:Q26703203 . \n",
 "SERVICE wikibase:around { 	\n",
  " ?item wdt:P625  ?location .\n",
   "bd:serviceParam wikibase:center \"Point("+coord.lng+" "+coord.lat+")\"^^geo:wktLiteral. \n",
  " bd:serviceParam wikibase:radius \""+width/1000+"\".\n",
 "}\n",
      "?item ?rell ?val .\n",
      " ?rel wikibase:directClaim ?rell .\n",
 	"SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\" }\n",
" }\n",
 "ORDER BY ?itemLabel\n",
    ].join(" ");
	console.log(query)
	var queryUrl = "https://query.wikidata.org/sparql?query="+ encodeURIComponent(query) +"&format=json";
  var res={}
//var queryUrl = encodeURI( "https://query.wikidata.org/sparql?query="+query+"&format=json" );
    $.ajax({
        dataType: "json",  
        url: queryUrl,
        async:false,
        success: function( _data ) {
            var wicket = new Wkt.Wkt();
            var myLayer = L.geoJSON().addTo(map);
            var results = _data.results.bindings;
            var mark;
            lastcoord=""
            popupBuffer="<ul>"
            var popupMap={}
             for ( var i in results ) {
                                //alert(results[i]["location"]["value"])
                                if(lastcoord!=results[i]["location"]["value"]){
                                    if(lastcoord!=""){
                                       Object.keys(popupMap).sort().map(function(cls) {
                                                    popupBuffer+=popupMap[cls]
                                       });
                                        popupBuffer+="</ul>";
                                        mark.bindPopup(popupBuffer);
                                        popupBuffer="<ul>";
                                        popupMap={}
                                    }
                                    popupBuffer+="<b><a href=\""+results[i]["item"]["value"]+"\" target=\"_blank\">"+results[i]["itemLabel"]["value"]+"</a></b>"
                                    popupMap[results[i]["relLabel"]["value"]+results[i]["valLabel"]["value"]]="<li><a href=\""+results[i]["rel"]["value"]+"\" target=\"_blank\">"+results[i]["relLabel"]["value"]+"</a> - <a href=\""+results[i]["val"]["value"]+"\">"+results[i]["valLabel"]["value"]+"</a></li>";
                                    wicket.read(results[i]["location"]["value"].replace("Point","POINT"));
                                    // "greenIcon from official documentation noted above.
                                    var feature = wicket.toJson();
                                    //alert(JSON.stringify(feature.coordinates))
                                    var greenIcon = new L.Icon({
                                        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    });
                                    mark=L.marker([feature.coordinates[1],feature.coordinates[0]],{icon: greenIcon})
                                    wikidatagroup.addLayer(mark)
                                    lastcoord=results[i]["location"]["value"]
                                }else{
                                   if(results[i]["val"]["value"].includes(".jpg") || results[i]["val"]["value"].includes(".JPG") || results[i]["val"]["value"].includes(".svg") || results[i]["val"]["value"].includes(".SVG")
						|| results[i]["val"]["value"].includes(".png") || results[i]["val"]["value"].includes(".PNG") || results[i]["val"]["value"].includes(".gif") || results[i]["val"]["value"].includes(".GIF")){
						popupMap[results[i]["relLabel"]["value"]+results[i]["valLabel"]["value"]]="<a href=\""+results[i]["rel"]["value"]+"\" target=\"_blank\">"+results[i]["relLabel"]["value"]+"</a> - <a href=\""+results[i]["val"]["value"]+"\" target=\"_blank\"><img src=\""+results[i]["val"]["value"].replace("http","https")+"\" height=\"30\" width=\"30\"></a></li>"	
                                    
                                    }else{
                                         popupMap[results[i]["relLabel"]["value"]+results[i]["valLabel"]["value"]]="<li><a href=\""+results[i]["rel"]["value"]+"\" target=\"_blank\">"+results[i]["relLabel"]["value"]+"</a> - <a href=\""+results[i]["val"]["value"]+"\">"+results[i]["valLabel"]["value"]+"</a></li>";
                                    }
                                }
            }
        }
    });  
    //layercontrol.addBaseLayer(wikidatagroup, 'wikidata');
	resultLayerCollection.push(wikidatagroup);
    return res;
	}
	return "";
}

function getAttributesForWikidataID(qid){
var query = [ "PREFIX bd: <http://www.bigdata.com/rdf#>\n",
                "PREFIX wikibase: <http://wikiba.se/ontology#>\n",
                "PREFIX wdt: <http://www.wikidata.org/prop/direct/>\n",
                "PREFIX wd: <http://www.wikidata.org/entity/>\n",
                "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>\n",          
                "SELECT DISTINCT ?itemLabel ?rel ?relLabel ?val ?valLabel\n",
                "WHERE\n",
                "{\n",
				"\twd:"+qid+" rdfs:label ?itemLabel .",
                "\twd:"+qid+" ?rell ?val .\n",
                "\t?rel wikibase:directClaim ?rell .\n",
                "\tSERVICE wikibase:label { bd:serviceParam wikibase:language \"en\" }\n",
                "}\n",
                "ORDER BY ?relLabel"
    ].join(" ");
  var queryUrl = "https://query.wikidata.org/sparql?query="+ encodeURIComponent(query) +"&format=json";
  var res={}
//var queryUrl = encodeURI( "https://query.wikidata.org/sparql?query="+query+"&format=json" );
    $.ajax({
        dataType: "json",  
        url: queryUrl,
        async:false,
        success: function( _data ) {
            //console.log(JSON.stringify(_data))
            var results = _data.results.bindings;
             for ( var i in results ) {
                 if(results[i]["rel"]["value"]!=undefined && results[i]["valLabel"]["value"]!=undefined){
                        res[results[i]["rel"]["value"]]=JSON.parse("{\""+results[i]["relLabel"]["value"]+"\":\""+results[i]["val"]["value"]+";"+results[i]["valLabel"]["value"]+"\"}")
                 }
            }
			res["rdfs:label"]=JSON.parse("{\"rdfs:label\":\"http://www.wikidata.org/entity/"+qid+";"+results[i]["itemLabel"]["value"]+"\"}")
            //alert(JSON.stringify(res))
        }
    });  
    return res;
}

function getMatchingWikiDataOSMAttributes(){
var query = [
"PREFIX bd: <http://www.bigdata.com/rdf#>\n" ,
                "PREFIX wikibase: <http://wikiba.se/ontology#>\n" ,
                "PREFIX wdt: <http://www.wikidata.org/prop/direct/>\n" ,
                "PREFIX wd: <http://www.wikidata.org/entity/>\n" ,
                "SELECT DISTINCT ?wdclass ?wdclassLabel ?osm\n" ,
                "WHERE\n" ,
                "{\n" ,
                "\t?wdclass wdt:P1282 ?osm .\n" ,
                "\tSERVICE wikibase:label { bd:serviceParam wikibase:language \"en\" }\n" ,
                "}\n" ,
                "ORDER BY ?wdclassLabel"
].join(" ");
var queryUrl = "https://query.wikidata.org/sparql?query="+ encodeURIComponent(query) +"&format=json";
//var queryUrl = encodeURI( "https://query.wikidata.org/sparql?query="+query+"&format=json" );
    $.ajax({
        dataType: "json",  
        async: false,
        url: queryUrl,
        success: function( _data ) {
            var results = _data.results.bindings;
            for ( var i in results ) {
                 if(results[i]["wdclass"]["value"]!=undefined && results[i]["osm"]["value"]!=undefined){
                  osmval=results[i]["osm"]["value"].replace("Key:","").replace("Tag:","");
                  if(osmval.includes("=")){
                        if(!osmToWikidataMap[osmval.substring(0,osmval.indexOf('='))]){
                            osmToWikidataMap[osmval.substring(0,osmval.indexOf('='))]={}
                        }
                        osmToWikidataMap[osmval.substring(0,osmval.indexOf('='))][osmval.substring(osmval.indexOf('=')+1)]=JSON.parse("{\""+results[i]["wdclass"]["value"]+"\":\""+("wdclassLabel" in results[i]?results[i]["wdclassLabel"]["value"]:"")+"\"}")
                  }else{
                        if(!osmToWikidataMap[osmval]){
                            osmToWikidataMap[osmval]={}
                        }
                        osmToWikidataMap[osmval][""]=JSON.parse("{\""+results[i]["wdclass"]["value"]+"\":\""+("wdclassLabel" in results[i]?results[i]["wdclassLabel"]["value"]:"")+"\"}")

                  }
                  				    if(!(wikidataToOSMMap[results[i]["wdclass"]["value"]])){
						 wikidataToOSMMap[results[i]["wdclass"]["value"]]=[]
					}
					wikidataToOSMMap[results[i]["wdclass"]["value"]].push(JSON.parse("{\""+osmval+"\":\""+("wdclassLabel" in results[i]?results[i]["wdclassLabel"]["value"]:"")+"\"}"));
                 }
            }
            wikidataToOSMMap["http://www.w3.org/2000/01/rdf-schema#label"]={}
            wikidataToOSMMap["http://www.w3.org/2000/01/rdf-schema#label"][""]="name"
            osmToWikidataMap["name"]={}
            osmToWikidataMap["name"][""]="http://www.w3.org/2000/01/rdf-schema#label"
            console.log("osmToWikidataMap: "+JSON.stringify(osmToWikidataMap))
            console.log("wikidataToOSMMap: "+JSON.stringify(wikidataToOSMMap))
        }
    });
}

function clearMap() {
	for(i in resultLayerCollection){
		//if(resultLayerCollection[i]._path != undefined) {
            try {
                map.removeLayer(resultLayerCollection[i]);
            }
            catch(e) {
                console.log("problem with " + e + map._layers[i]);
            }
        //}
	}
    /*for(i in map._layers) {
        if(map._layers[i]._path != undefined) {
            try {
                map.removeLayer(map._layers[i]);
            }
            catch(e) {
                console.log("problem with " + e + map._layers[i]);
            }
        }
    }*/
	/*for(marker in markercollection){
		map.removeLayer(markercollection[marker])
	}
	markercollection=[]
        for(decorator in decorators){
		map.removeLayer(decorators[decorator])
	}
	decorators=[]*/
}


function loadItems(){
    getOSMAttributesForCoordinate(map);
}

function loadWDItems(){
	var distance = getDistance([map.getBounds().getSouth(), map.getBounds().getWest()],[map.getBounds().getNorth(),map.getBounds().getEast()])
        width=distance/2
	wikidataAroundQuery(map.getCenter(),width);
}
function zoomAndReload(){
		if(map.getZoom()>=minMapZoom){
			$('#mapid').css("border","5px solid green")
		}else{
			$('#mapid').css("border","5px solid black")
		}
           if(loaded && document.getElementById('autoload').checked){
            clearMap();	
            loadItems();
			loadWDItems();
        }
}

</script>

</head>
<body>
<h2 align="center">Stolperstein Mapview</h2>

<div id="mapid" style="height:80%;border:5px solid black;">
<script>
var wikidataToOSMMap={}
var osmToWikidataMap={}
	var map = L.map('mapid',{fullscreenControl: true,fullscreenControlOptions: {position: 'topleft'}}).setView([49.998889, 8.274167], 16).locate({setView: true, maxZoom: 22});
	map.addControl( new L.Control.Search({
		url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
		jsonpParam: 'json_callback',
		propertyName: 'display_name',
		propertyLoc: ['lat','lon'],
		marker: L.circleMarker([0,0],{radius:30}),
		autoCollapse: true,
		autoType: false,
		minLength: 2
	}));
        
getMatchingWikiDataOSMAttributes();
		
    map.on('dragend', function() {
        zoomAndReload();
	});
	    map.on('zoomend', function() {
        zoomAndReload();
	});
/*map.on('moveend',function(){
        map.eachLayer(function (layer) {
            try{
            map.removeLayer(layer);
            }catch{}
        });
        if(loaded){
            map.removeLayer(layer);		
            loadItems();
        }
});*/

	var layer=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});

var officiallayer=L.geoJSON(stolpersteine,{
onEachFeature: function (feature, layer) {
	 var popup="Official Data Point<br/><ul>"
	 for(prop in feature.properties){
	 	popup+="<li>"+prop+" - "+feature.properties[prop]+"</li>"
	 }
	 popup+="</ul>"
         layer.bindPopup(popup);
     }})

var aschaffenburg=L.geoJSON(stolpersteine2,{
onEachFeature: function (feature, layer) {
	 var popup="Official Data Point<br/><ul>"
	 for(prop in feature.properties){
	 	popup+="<li>"+prop+" - "+feature.properties[prop]+"</li>"
	 }
	 popup+="</ul>"
         layer.bindPopup(popup);
     }})

var wiesbaden=L.geoJSON(stolpersteinewiesbaden,{
onEachFeature: function (feature, layer) {
	 var popup="Official Data Point<br/><ul>"
	 for(prop in feature.properties){
	 	popup+="<li>"+prop+" - "+feature.properties[prop]+"</li>"
	 }
	 popup+="</ul>"
         layer.bindPopup(popup);
     }})
	overlayMaps["Aschaffenburg"]=aschaffenburg
	overlayMaps["Mainz"]=officiallayer
	overlayMaps["Wiesbaden"]=wiesbaden
		var wmsLayer = L.tileLayer.wms('https://sgx.geodatenzentrum.de/wms_topplus_web_open', {
layers: 'web',
format: 'image/png',
 transparent: true,
attribution: '&copy; Bundesamt f&uuml;r Kartographie und Geod&auml;sie 2017, <a href="https://sg.geodatenzentrum.de/web_public/Datenquellen_TopPlus_Open.pdf">Datenquellen</a>'
});
	var baseMaps = {
		"BKG": wmsLayer,
        "OSM": layer
	};
	baseMaps["OSM"].addTo(map);
	L.control.scale({
	position: 'bottomright',
	imperial: false
}).addTo(map);
var layercontrol=L.control.layers(baseMaps,overlayMaps).addTo(map);
loaded=true;
zoomAndReload();
</script>
</div>
<!--<button type="button" id="loadbutton" onClick="loadItems()">Load OSM Stolperstein items</button>
<button type="button" id="loadbutton2" onClick="loadWDItems()">Load Wikidata Stolperstein Items</button>
<button type="button" id="clearbutton" onClick="clearMap()">Clear Map</button><br/>-->
Autoload<input type="checkbox" id="autoload"/><br/>
<select id="officialsetmenu">
	<option value="stolpersteine2">Stolpersteine Aschaffenburg</option>
	<option value="stolpersteine" selected="selected">Stolpersteine Mainz</option>
	<option value="stolpersteinewiesbaden">Stolpersteine Wiesbaden</option>
	</select>
<a href="stolperstein_editor.html" target="_blank">Stolperstein Editor</a><br>
<a href="mapview.html" target="_blank">Mapview for modelled Stolpersteine (using the Editor)</a><br/>
<button id="exportOSM" onClick="exportOSM()">Export OSM as GeoJSON</button>
<button id="exportWD" onClick="exportWD()">Export Wikidata as GeoJSON</button><br/>
<button id="exportCombined" onClick="exportCombined()">Export String Distance Comparison as JSON</button><br/>
Legend: <table><tr>
<td style="color:gray">Grey Marker</td><td>In Wikidata and OSM</td></tr><tr><td style="color:blue">Blue Marker</td><td>In OSM and not in Wikidata</td></tr><!--<tr><td style="color:green">Green Marker</td><td>In Wikidata and not in OSM</td></tr>--></table>
</body>
</html>
